<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Letsee WebAR Demo - Escape Room 1.0</title>
	<meta content="minimum-scale=1.0, width=device-width, maximum-scale=1, user-scalable=no, viewport-fit=cover" name="viewport" />

	<script src="./vendor/letsee/Letsee.0.9.10.js"></script>
	<script src="./vendor/jquery/jquery-1.9.1.min.js"></script>
	<script src="https://hammerjs.github.io/dist/hammer.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

	<link rel="stylesheet" href="css/layout.css"/>
	<link rel="stylesheet" href="css/renderable.css"/>

	<style media="place" type="text/css">
		#container {-letsee-target: uri('toystory.json');-letsee-position: coords(0, 0, 0);}
	</style>

	<style>
		.cardElement {
			width: 400px;
			height: 400px;
			font-size: 40px;
			background: rgba(255, 255, 255, 0.8);
			border-radius: 5%;
			border: 10px solid rgba(0, 0, 0, 0.48);
			padding: 15px;
		}
		.imagebox {
			width: 100%;
		}
		.imagebox img {
			display: block;
			margin: 0 auto;
		}
	</style>

</head>
<body>


<div id="container"></div>

<div id="btnAdd" onclick="showMenuDiv()"></div>
<div id="menu">
	<div id="buttons">
		<div id="addText"  class="btnMenu" onclick='showInputTextDiv()'></div>
		<div id="addImage" class="btnMenu" onclick="addNewImage();"></div>
		<div id="addLink" class="btnMenu" onclick="saveEdit();"></div>
		<div id="addSearch" class="btnMenu" onclick="addUcc();"></div>
		<div id="addYoutube" class="btnMenu" onclick="addNewYoutube();"></div>
	</div>
</div>

<img id="btnHelp" src="assets/help.png" onclick="showHelpImage();" />
<div id="divHelp">
	<img id="imgHelp">
	</img>
</div>

<div id="inputText">
	<div id="inputHeader" class="page-header">
		<p>Input Text</p>
		<img src="assets/close.png" onclick="showInputTextDiv()" />
	</div>
	<div id="imageUpload">
		<input type="file" id="uploadImageInput" accept=".jpg,.jpeg.,.gif,.png">
	</div>
	<textarea id="inputArea" placeholder="이 곳에 텍스트를 입력해 글을 게시합니다"></textarea>
	<div id="btnLetseeit">
		<img src="assets/letsee_it.png" onclick="createCard()" />
	</div>
</div>

<div id="inputConfirm">
	<!-- 완료버튼 눌렀을 시 서버에 데이터 저장하고 보여주기 -->
	<div onclick="save();" class="icon-edit-sucsess">완료</div>
	<img onclick="removeCard()" src="assets/btn-trash.svg" id="delete-input"/>
	<!--
  <div class="edit-target-see-wrapper">
    <img class="edit-target-see-frame lt" src="assets/lt3x.png" >
    <img class="edit-target-see-frame rt" src="assets/rt3x.png" >
    <img class="edit-target-see-frame lb" src="assets/lb3x.png" >
    <img class="edit-target-see-frame rb" src="assets/rb3x.png" >
  </div>
  -->
</div>
</body>

<script type="text/javascript" src="js/layout.js"></script>
<script type="text/javascript" src="./thumb.js"></script>
<script>
    /* Letsee init */
    const config = {
        "appKey": "Tb8arp5eF9ZMDw0u2QiOyV845R61eltmeZQKwFBXBeeNU9Q5vgpduQdF5oipQX9X",
        "trackerType": "PLANAR"
    };
    const app = new Letsee(config);
    let currentCardObject = null;

    app.addEventListener("trackstart", function(e) {
        let uri = e.target.uri;
        if (uri !== CURRENT_URI) {
            /*
                if (CURRENT_URI) {
                      LetseeEngine.getEntity(CURRENT_URI).removeRenderable(world);
                      CURRENT_URI = uri;
                      currentTarget = LetseeEngine.getEntity(CURRENT_URI);

                      //ready();
                  }

                  CURRENT_URI = uri;
                  e.target.addRenderable(world);

                  let depth = e.target.size.depth === null ? 0 : e.target.size.depth/2;
                  world.position.z = depth;
              }
          }*/
        }});
    app.addEventListener("trackmove", function(e) {
    });
    app.addEventListener("trackend", function(e) {
    });
    app.addEventListener('app_status', e => {
        switch(e.code) {
            case 203:
                initWorldObject3D(app.letseeEngine.getEntities());
                break;
            default:
                console.log(e);
                break;
        }
    });


    $(function() {
        initLayout();
    });

    function UUID() {
        let d = new Date().getTime();

        if (typeof performance !== 'undefined' && typeof performance.now === 'function') {
            d += performance.now(); // use high-precision timer if available
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            let r = (d + Math.random() * 16) % 16 | 0;

            d = Math.floor(d / 16);
            return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
    }

    /* Set ajax */

    const objectTemplate = {
        "id": null,
        "type": null,
        "content": null,
        "imageUrl": null,
        "position": {
            "_x": null,
            "_y": null,
            "_z": null
        },
        "rotation": {
            "_x": null,
            "_y": null,
            "_z": null
        },
        "scale": {
            "_x": null,
            "_y": null,
            "_z": null
        }
    };
    // init Parse server
    axios.defaults.baseURL = 'http://localhost:8811/parse/';
    axios.defaults.headers.common['X-Parse-Application-Id'] = 'ar-docent';
    axios.defaults.headers.common['X-Parse-REST-API-Key'] = 'djasklasdas';

    function updateCardObject(args) {
        return {...currentCardObject, ...args}
    }

    function saveImage() {
        axios.post('files/'+ currentCardObject.id , imageObj.files[0])
            .then( (data) => {
                currentCardObject.imageUrl = data.data.url;
                //let img = document.querySelector(`img[data-id='${currentCardObject.id}']`);
                //img.src = data.data.url;

                currentCardObject.content = `
					<div class="cardElement" data-type="card" data-id="${currentCardObject.id}">
						<div class="wrapper">
							<div class="inner">
								<div class="imagebox"><img src=${data.data.url} data-type="cardImage" data-id="${currentCardObject.id}"></div>
								<div class="textBox">
									${cardContentInput.value}
								</div>
							</div>
						</div>
					</div>`;

                //postCard();
                axios.post('classes/wallboard', updateCardObject(currentCardObject))
                    .then(() => {
                        currentCardObject = null;
                        editObject = null;
                        currentCardObject = objectTemplate;
                        cardContentInput.value = ""
                    })
                    .catch(error => {
                        console.warn(error);
                    });
            })
            .catch(error => {
                console.warn(error);
            })
    }

    function postCard() {
        if(currentCardObject.type === "image") {
            saveImage();
        } else {
            axios.post('classes/wallboard', updateCardObject(currentCardObject))
                .then(() => {
                    currentCardObject = null;
                    editObject = null;
                    currentCardObject = objectTemplate;
                    cardContentInput.value = ""

                })
                .catch(error => {
                    console.warn(error);
                });
        }
    }

    function getCardData() {
        axios.get('classes/wallboard',{
            params: {
                order: '-createdAt'
            }})
            .then(data => {
                printCardsItemFromJson(data.data.results);
                currentCardObject = null;
                editObject = null;
                currentCardObject = objectTemplate;
            })
            .catch(error => {
                console.warn(error);
            })
    }

    // 초기 화면 렌더링
    getCardData();


    /* Publish card */
    let editObject;
    let CURRENT_URI = '';
    let currentTarget = null;

    const world = new Object3D();
    const cardContentInput = document.getElementById('inputArea');
    const imageObj = document.getElementById('uploadImageInput');

    // Function to make renderable item and renderable item's position, rotation, scale.
    function createDOMRenderable(value, _position = null, _rotation = null, _scale = null) {
        let element = document.createElement('div');
        element.innerHTML = value;

        const renderableEle = new DOMRenderable(element);

        // Set position
        if (_position) renderableEle.position.set(..._position);

        // Set rotation
        if (_rotation) {
            renderableEle.rotateX(_rotation[0]);
            renderableEle.rotateY(_rotation[1]);
            renderableEle.rotateZ(_rotation[2]);
        }

        // Set scale

        if (_scale) {
            renderableEle.scale.set(..._scale);
        }

        // if (_scale) renderableEle.scale.set(..._scale);
        return renderableEle ;
    }


    function printCardsItemFromJson(data) {
        // let cardObjects = JSON.parse(JSON.stringify(data));
        data.forEach(function(item, index) {
            let position  = [item.position._x, item.position._y, (index * -50) -50];
            let rotation  = [item.rotation._x, item.rotation._y, item.rotation._z];
            let scale = [item.scale._x, item.scale._y, item.scale._z];
            let renderableItem = createDOMRenderable(item.content, position, rotation, scale);
            world.add(renderableItem);

        });
    }

    // Initialize app.
    function initWorldObject3D(entity) {
        entity[0].addRenderable(world);
        currentTarget = LetseeEngine.getEntities()[0]
    }


    // const imageThumbnail = new CreateThumbnail();
    // 카드 만들기. 인풋창에 들어간 내용으로 html태그 제작
    function createCard() {
        // document.querySelector("img[data-id='bfcc46bb-b047-4fcf-a8b5-9128139f1aff']")
        // 이미지 업로드시
        if(imageObj.files.length > 0) {

            const randomId = UUID();
            const type = "image";
            const content = `
				<div class="cardElement" data-type="card" data-id="${randomId}">
					<div class="wrapper">
						<div class="inner">
							<div class="imagebox"><img src="" data-type="cardImage" data-id="${randomId}"></div>
							<div class="textBox">
								${cardContentInput.value}
							</div>
						</div>
					</div>
				</div>`;

            currentCardObject = updateCardObject({
                "id": randomId,
                "type": type,
                "content": content,
            });

            addCard();

        } else {

            const randomId = UUID();
            const type = "text";
            const content = `
				<div class="cardElement" data-type="card" data-id="${randomId}">
					<div class="wrapper">
						<div class="inner">
							<div class="imagebox"><img src="" data-type="cardImage" data-id="${randomId}"></div>
							<div class="textBox">
								${cardContentInput.value}
							</div>
						</div>
					</div>
				</div>`;

            currentCardObject = updateCardObject({
                "id": randomId,
                "type": type,
                "content": content
            });

            addCard(null);
            cardContentInput.value = "";
        }
    }

    let renderable = null;
    let currentCardIndex = 0;
    // 카드 화면에 붙이기. 위에 만든 카드를 화면에 붙이고 hammer이벤트로 조정
    function addCard(imgData) {
        let position = [0,0,50 * currentCardIndex];
        let rotation = [0,0,0];
        let scale = [1,1,1];
        renderable = createDOMRenderable(currentCardObject.content, position, rotation, scale);

        world.add(renderable);
        editObject = renderable;
        currentCardIndex ++;

        if(imgData !== null) {
            //let img = document.querySelector(`img[data-id='${currentCardObject.id}']`);
            //img.src = imgData;
            //console.log(img);
        }

        // currentCard = editObject;
        // Set layout
        showInputTextDiv();
        showInputConfirmDiv();

        /**
         * src = 이미지 base64가 두번 호출되어야만 resizing 수행. => 원인 파악 x
         */
        ResizeImage();
        ResizeImage();
    }

    function removeCard() {
        if(renderable !== null) {
            world.remove(renderable);
            editObject = null;
            currentCardIndex --;
        }

        showInputConfirmDiv();
    }


    // 서버 전송
    function save() {
        currentCardObject = updateCardObject(
            {
                "position": {
                    "_x": editObject.position._x,
                    "_y": editObject.position._y,
                    "_z": editObject.position._z
                },
                "rotation": {
                    "_x": editObject.rotation._x,
                    "_y": editObject.rotation._y,
                    "_z": editObject.rotation._z
                },
                "scale": {
                    "_x": editObject.scale._x,
                    "_y": editObject.scale._y,
                    "_z": editObject.scale._z
                }
            }
        );

        showInputConfirmDiv();
        postCard();
    }


    // width, height 최대값이 380으로 이미지 리사이징.
    function ResizeImage() {
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            const filesToUploads = imageObj.files;
            const file = filesToUploads[0];


            console.log(imageObj.files[0]);
            console.log("zz");

            if (file) {

                const reader = new FileReader();
                // Set the image once loaded into file reader
                reader.onload = function(e) {

                    var img = document.createElement("img");
                    img.src = e.target.result;
                    console.log(dataURLToBlob(e.target.result));


                    var canvas = document.createElement("canvas");
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);

                    var MAX_WIDTH = 380;
                    var MAX_HEIGHT = 380;
                    var width = img.width;
                    var height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);

                    let dataurl = canvas.toDataURL(file.type);
                    //document.getElementById('output').src = dataurl;

                    let myImg = document.querySelector(`img[data-id='${currentCardObject.id}']`);
                    myImg.src = dataurl;

                };
                reader.readAsDataURL(file);
            }
        } else {
            alert('The File APIs are not fully supported in this browser.');
        }
    }

	// dataUrl을 blob형식으로 바꿔준다.
    var dataURLToBlob = function(dataURL) {
        var BASE64_MARKER = ';base64,';
        if (dataURL.indexOf(BASE64_MARKER) == -1) {
            var parts = dataURL.split(',');
            var contentType = parts[0].split(':')[1];
            var raw = parts[1];

            return new Blob([raw], {type: contentType});
        }

        var parts = dataURL.split(BASE64_MARKER);
        var contentType = parts[0].split(':')[1];
        var raw = window.atob(parts[1]);
        var rawLength = raw.length;

        var uInt8Array = new Uint8Array(rawLength);

        for (var i = 0; i < rawLength; ++i) {
            uInt8Array[i] = raw.charCodeAt(i);
        }

        /* : blob를 파일 형태로 바꿔줌. (리사이징 된 이미지를 서버로 전송할 때)
        	const fd = new FormData();
            fd.set('a',dataURLToBlob(dataurl));
            console.log(fd.get('a'));
         */

        return new Blob([uInt8Array], {type: contentType});
    }

</script>
<!-- hammer motion code -->
<script type="text/javascript" src="js/hammer.js"></script>

<!-- input area
<img >
<textarea>
dhsjakjdklsajkdllsja
</textarea>
<script type="text/javascript" src="js/main.js"></script>
<script type="text/javascript" src="js/eventController.js"></script>
-->

</html>
