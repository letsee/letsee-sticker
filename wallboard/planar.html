<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Letsee WebAR Demo - Escape Room 1.0</title>
	<meta content="minimum-scale=1.0, width=device-width, maximum-scale=1, user-scalable=no, viewport-fit=cover" name="viewport" />

	<script src="./vendor/letsee/Letsee.0.9.10.js"></script>
	<script src="./vendor/jquery/jquery-1.9.1.min.js"></script>
	<script src="https://hammerjs.github.io/dist/hammer.js"></script>

	<link rel="stylesheet" href="css/layout.css"/>
	<link rel="stylesheet" href="css/renderable.css"/>

	<style media="place" type="text/css">
		#container {-letsee-target: uri('toystory.json');-letsee-position: coords(0, 0, 0);}
	</style>

	<style>
		.test {
			border: 1px solid #f00;
			width: 100px;
			height: 100px;
		}
	</style>

</head>
<body>


<div id="container" class="test"></div>

<div id="btnAdd" onclick="showMenuDiv()"></div>
<div id="menu">
	<div id="buttons">
		<div id="addText"  class="btnMenu" onclick='showInputTextDiv()'></div>
		<div id="addImage" class="btnMenu" onclick="addNewImage();"></div>
		<div id="addLink" class="btnMenu" onclick="saveEdit();"></div>
		<div id="addSearch" class="btnMenu" onclick="addUcc();"></div>
		<div id="addYoutube" class="btnMenu" onclick="addNewYoutube();"></div>
	</div>
</div>

<img id="btnHelp" src="assets/help.png" onclick="showHelpImage();" />
<div id="divHelp">
	<img id="imgHelp">
	</img>
</div>

<div id="inputText">
	<div id="inputHeader" class="page-header">
		<p>Input Text</p>
		<img src="assets/close.png" onclick="showInputTextDiv()" />
	</div>
	<textarea id="inputArea" placeholder="이 곳에 텍스트를 입력해 글을 게시합니다"></textarea>
	<div id="btnLetseeit">
		<img src="assets/letsee_it.png" onclick="createTextCard()" />
	</div>
</div>


<div id="inputConfirm">
	<!-- 완료버튼 눌렀을 시 서버에 데이터 저장하고 보여주기 -->
	<div onclick="save();" class="icon-edit-sucsess">완료</div>
	<img onclick="typeLoadControl(1, 0);" src="assets/btn-trash.svg" id="delete-input"/>
	<!--
  <div class="edit-target-see-wrapper">
    <img class="edit-target-see-frame lt" src="assets/lt3x.png" >
    <img class="edit-target-see-frame rt" src="assets/rt3x.png" >
    <img class="edit-target-see-frame lb" src="assets/lb3x.png" >
    <img class="edit-target-see-frame rb" src="assets/rb3x.png" >
  </div>
  -->
</div>
</body>

<script type="text/javascript" src="js/layout.js"></script>
<script>
	const config = {
		"appKey": "Tb8arp5eF9ZMDw0u2QiOyV845R61eltmeZQKwFBXBeeNU9Q5vgpduQdF5oipQX9X",
		"trackerType": "PLANAR"
	};
	const app = new Letsee(config);

	let editObject;
	let CURRENT_URI = '';
	let currentTarget;
	const objectTemplate = {
		"id": null,
		"type": null,
		"content": null,
		"imageName": null,
		"position": {
			"_x": null,
			"_y": null,
			"_z": null
		},
		"rotation": {
			"_x": null,
			"_y": null,
			"_z": null
		},
		"scale": {
			"_x": null,
			"_y": null,
			"_z": null
		}
	};

	$(function() {
		initLayout();
	});

	app.addEventListener("trackstart", function(e) {
		let uri = e.target.uri;
		if (uri !== CURRENT_URI) {
			if (CURRENT_URI) {
				LetseeEngine.getEntity(CURRENT_URI).removeRenderable(world);
				CURRENT_URI = uri;
				currentTarget = LetseeEngine.getEntity(CURRENT_URI);

				//ready();
			}

			CURRENT_URI = uri;
			e.target.addRenderable(world);

			let depth = e.target.size.depth === null ? 0 : e.target.size.depth/2;
			world.position.z = depth;
		}
	});

	app.addEventListener("trackmove", function(e) {
		console.log(e);
		console.log(e);
	});

	app.addEventListener('app_status', e => {
		switch(e.code) {
			case 203:
				initWorldObject3D(app.letseeEngine.getEntities());
				break;
			default:
				console.log(e);
				break;
		}
	});


	const world = new Object3D();

	function addTextItem() {
		//let text = $('#inputArea').val();

		// 첫번째 변수로 element의 css를 넣고 두번째 변수로
		//let jungwooText = createDOMRenderable("<div>" + text + "</div>", 'target-ready-content');

		//editObject = jungwooText;
		//showInputTextDiv();
		//showInputConfirmDiv();
	}

	const cardContentInput = document.getElementById('inputArea');

	function createDOMRenderable(value, className, _position = null, _rotation = null, _scale = null) {
		let element = document.createElement('div');
		element.innerHTML = value;
		element.className = className ? className : '';

		const renderableEle = new DOMRenderable(element);

		// renderableEle.position.set(..._position);

		if (_position) renderableEle.position.set(..._position);

		if (_rotation) {
			renderableEle.rotateX(_rotation[0]);
			renderableEle.rotateY(_rotation[1]);
			renderableEle.rotateZ(_rotation[2]);
		}

		if (_scale) {
			renderableEle.scale.set(_scale, _scale, _scale);
		}

		// if (_scale) renderableEle.scale.set(..._scale);
		return renderableEle ;
	}

	// Init first object
	function initWorldObject3D(entity) {
		let position = [50,40,1];
		let rotation = [5,80,10];

		world.add(
				createDOMRenderable('aaaaaa','test',position, rotation)
		);
		entity[0].addRenderable(world);
		currentTarget = LetseeEngine.getEntity('toystory.json');

	}

	let currentCard = null;
	let currentCardObject = null;

	function updateCardObject(arg) {
		return {...currentCardObject, ...arg};
	}

	// 카드 만들기. 인풋창에 들어간 내용으로 html태그 제작
	function createTextCard(_type = null) {
		const randomId = "dummy";
		const type = _type || null;
		const content = `
<div class="cardElement" rel="card">
	<div class="wrapper">
		<div class="inner">
			<div class="imagebox"></div>
			<div class="textBox">
				${cardContentInput.value}
			</div>
		</div>
	</div>
</div>`;
		currentCardObject = updateCardObject({
			"id": randomId,
			"type": type,
			"content": content,
		})
		addCard();
		cardContentInput.value = "";
	}




	// 카드 화면에 붙이기. 위에 만든 카드를 화면에 붙이고 hammer이벤트로 조정
	function addCard() {
		let position = [0,0,0];
		let rotation = [0,0,0];
		let scale = 1;

		let renderable = createDOMRenderable(currentCardObject.content, "test", position, rotation, scale);
		world.add(renderable);

		editObject = renderable;


		showInputTextDiv();
		showInputConfirmDiv();
		currentCard = editObject;

	}

	// 서버 전송
	function save() {
		console.log(currentCard);
		currentCardObject =  updateCardObject(
				{
					"position": {
						"_x": currentCard.position._x,
						"_y": currentCard.position._y,
						"_z": currentCard.position._z
					},
					"rotation": {
						"_x": currentCard.rotation._x,
						"_y": currentCard.rotation._y,
						"_z": currentCard.rotation._z
					},
					"scale": {
						"_x": currentCard.scale._x,
						"_y": currentCard.scale._y,
						"_z": currentCard.scale._z
					}
				}
		)
		showInputConfirmDiv();


		postCard(currentCardObject)
				.then(data => {
					// remove currentCard = editObject => null

					// reset
					currentCardObject = objectTemplate;
				})
	}
</script>

<!-- hammer motion code -->
<script type="text/javascript" src="js/hammer.js"></script>

<!-- input area
<img >
<textarea>
dhsjakjdklsajkdllsja
</textarea>
<script type="text/javascript" src="js/main.js"></script>
<script type="text/javascript" src="js/eventController.js"></script>
-->


</html>
