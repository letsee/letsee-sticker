<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Letsee WebAR Demo - Post your picture | Wallboard</title>
	<meta content="minimum-scale=1.0, width=device-width, maximum-scale=1, user-scalable=no, viewport-fit=cover" name="viewport" />

	<script src="./libs/Letsee.0.9.10.min.js"></script>
	<script src="./vendor/jquery/jquery-1.9.1.min.js"></script>
	<script src="https://hammerjs.github.io/dist/hammer.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

	<link rel="stylesheet" href="css/layout.css"/>
	<link rel="stylesheet" href="css/renderable.css"/>

	<style media="place" type="text/css">
		#container {-letsee-target: uri('world_map.json');-letsee-position: coords(0, 0, 0);}
	</style>
	<style>

		@media all and (orientation:portrait) {
			#recommendDiv {
				display: block !important;
			}
		}
		@media all and (orientation:landscape) {
			#recommendDiv {
				display: none !important;
			}
		}

	</style>
</head>
<body>

<div id="container"></div>

<!-- when layout vertical -->
<div id="recommendDiv">
	<div id="recommendDivHeader">
		<img id="recommendDivHeaderImg" src="assets/horizontal_message.png"/>
	</div>
	<img id="recommendDivImg" src="assets/landscape_phone.png"/><br/>
	<div id="recommendDivFooter">
		<img id="recommendDivFooterImageFirst" src="assets/horizontal_message2.png"/>
		<img id="recommendDivFooterImageSecond" src="assets/horizontal_info.png"/>
	</div>
</div>

<!-- 첫화면 (main) -->
<div id="mainDiv">
	<img id="addButton"  src="assets/add_button.png" onclick="goToAddCardDiv()"/>
	<div id="mainDivFooter">
		<img id="mainDivFooterImg" src="assets/letsee_bottom.png"/>
	</div>
</div>

<!-- 첫화면 (가이드) -->
<div id="guideDiv">
	<br/>
	<img src = "assets/letsee.png" style="width:10%"/><br/>
	<img src = "assets/guide1.png" style="width:20%"/><br/>
	<img src = "assets/line.png" style="width:60%"/><br/><br/>
	<img src = "assets/guide2.png" style="width:50%"/><br/>
	<img src = "assets/guide3.png" style="width:50%"/><br/>
	<img src = "assets/line.png" style="width:60%"/><br/><br/>
	<img src = "assets/guide4.png" style="width:60%"/>
</div>

<input style="display:none" type="file" id="uploadImageInput" name='uploadImageInput' accept=".jpg,.jpeg.,.gif,.png" >

<div id="addCardDiv">
	<div id="postHeader">
		<img id="backToMainImg" src="assets/back_button.png" onclick = "goToMain(false)">
		<p>Please pick your pictures and post it!</p>
	</div>
	<div id="cardHolder">
		<div class="inner" onclick="fileClick()">
			<img id="rectangleImg" class="sourceImg" src="assets/placeholder.png">
		</div>
	</div>
	<div style="position:absolute;width:100%; bottom:4%">
		<img src="assets/post_message.png" style="width:15%;" onclick="createCard()"/>
	</div>
</div>

<!-- 카드 이동 화면 -->
<div id="moveCardDiv">
	<div id="moveCardDivHeader">
		<img id="backToAddCardDivImg" src="assets/back_button.png" onclick = "goToAddCardDiv()">
		<img src="assets/move_card_message.png" style="width:55%;"/>
	</div>
	<div id="moveCardDivFooter">
		<img id="moveCardDivFooterCheckImage" src="assets/check_button.png" onclick = "postCard()" />
		<img id="moveCardDivFooterCancelImage" src="assets/x_button2.png" onclick="goToMain(false)"/>
	</div>
</div>

<div id="inputConfirm">
	<div onclick="postCard();" class="icon-edit-sucsess">완료</div>
	<img onclick="removeCard()" src="assets/btn-trash.svg" id="delete-input"/>
</div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/screenfull.js/4.2.0/screenfull.min.js"></script>
<script>let fs=!1;document.documentElement.addEventListener("click",()=>{screenfull.enabled&&!fs&&(screenfull.request(),fs=!0)});</script>

<script type="text/javascript" src="./js/layout.js"></script>
<script type="text/javascript" src="./thumb.js"></script>
<script>
  /* Letsee init */
  const config = {
    "appKey": "Tb8arp5eF9ZMDw0u2QiOyV845R61eltmeZQKwFBXBeeNU9Q5vgpduQdF5oipQX9X",
    "trackerType": "PLANAR"
  };
  const app = new Letsee(config);
  let currentCardObject = null;

  let CURRENT_URI = null;
  let currentTarget = null;
  const world = new Object3D();

  LetseeEngine.addEventListener("trackstart", function(e) {
    let uri = e.target.uri;

    if(CURRENT_URI == null) {
      CURRENT_URI = uri;
      currentTarget = LetseeEngine.getEntity(CURRENT_URI);
      e.target.addRenderable(world);
    }

    if (uri !== CURRENT_URI) {
      LetseeEngine.getEntity(CURRENT_URI).removeRenderable(world);
      CURRENT_URI = uri;
      currentTarget = LetseeEngine.getEntity(CURRENT_URI);
      e.target.addRenderable(world);
      //ready();
      //let depth = e.target.size.depth === null ? 0 : e.target.size.depth/2;
      //world.position.z = depth;
    }

  });
  LetseeEngine.addEventListener("trackmove", function(e) {
  });
  LetseeEngine.addEventListener("trackend", function(e) {
  });
  LetseeEngine.addEventListener('app_status', e => {
    switch(e.code) {
      case 203:
        initWorldObject3D(LetseeEngine.getEntities());
        break;
      default:
        console.log(e);
        break;
    }
  });

  // Function to initialize layout.
  $(function() {
    initOrientation();
  });

	// Template : JSON type which save renderable item's position, rotation, scale and imageUrl.
  const objectTemplate = {
    "id": null,
    "type": null,
    "content": null,
    "imageUrl": null,
    "position": {
      "_x": null,
      "_y": null,
      "_z": null
    },
    "rotation": {
      "_x": null,
      "_y": null,
      "_z": null
    },
    "scale": {
      "_x": null,
      "_y": null,
      "_z": null
    }
  };

  axios.defaults.baseURL = 'https://browser.letsee.io:8337/parse';
  axios.defaults.headers.common['X-Parse-Application-Id'] = 'awe2019wallboard';

  function updateCardObject(args) {
    return {...currentCardObject, ...args}
  }

  /**
   *  1. First upload image to server and get Image url;
   *  2. Second upload resized image to server and get resized Image url;
   *  3. Third put image url and resized image url to card object and upload card object;
   */
  let prefix = "https://browser.letsee.io:8337/parse/files/awe2019wallboard/";

  // Function for updating origin image (half_resized)
  const saveImage = function() {
    return new Promise((resolve, reject) => {
      axios.post('files/'+ currentCardObject.id , halfResizedFile)
        .then((data) => {
          let imageUrl = `${prefix}${data.data.name}`;
          resolve(imageUrl)
        })
        .catch(error => {
          reject(error);
        })
    });
  };

  // Function for updating thumbnail image (resized 380*380)
  const saveResizedImage =  function (imageUrl) {
    return new Promise((resolve, reject) => {
      axios.post('files/'+ currentCardObject.id + '_thumbnail' , resizedFile)
        .then((data) => {
          var object = {
            imageUrl : imageUrl,
            resizedImageUrl : `${prefix}${data.data.name}`
          };
          resolve(object)
        })
        .catch(error => {
          reject(error);
        })
    });
  };

  // Function to make card element DIV and upload to server.
  const uploadImagesAndCardObject = function(object) {
    return new Promise((resolve, reject) => {
      currentCardObject.imageUrl = object.imageUrl;
      currentCardObject.resizedImageUrl = object.resizedImageUrl;
      //let img = document.querySelector(`img[data-id='${currentCardObject.id}']`);
      //img.src = data.data.url;

      currentCardObject.content = `<div class="cardElement" data-type="card" data-id="${currentCardObject.id}">
        			<div class="wrapper">
        				<div class="inner">
        					<div class="imagebox">
        						<img src=${object.resizedImageUrl} data-original="${object.imageUrl}" data-type="cardImage" data-id="${currentCardObject.id}"
        					</div>
        				</div>
        			</div>`

      axios.post('classes/wallboard', updateCardObject(currentCardObject))
        .then((result) => {
          currentCardObject = null;
          editObject = null;
          currentCardObject = objectTemplate;
          resolve(result);
        })
        .catch(error => {
          reject(error);
        });
    });
  };

  // Function to get card data from server
  function getCardData() {
    axios.get('classes/wallboard',{
      params: {
        order: '-createdAt'
      }})
      .then(data => {
        printCardsItemFromJson(data.data.results);
        currentCardObject = null;
        editObject = null;
        currentCardObject = objectTemplate;
      })
      .catch(error => {
        console.warn(error);
      })
  }

  // 초기 화면 렌더링
  getCardData();

  /* Publish card */
  let editObject;
  let helpObject;

  const imageObj = document.getElementById('uploadImageInput');

  // Function to make renderable item and renderable item's position, rotation, scale.
  function createDOMRenderable(value, _position = null, _rotation = null, _scale = null) {
    let element = document.createElement('div');
    element.innerHTML = value;

    const renderableEle = new DOMRenderable(element);

    if (_position) renderableEle.position.set(..._position);

    if (_rotation) {
      renderableEle.rotateX(_rotation[0]);
      renderableEle.rotateY(_rotation[1]);
      renderableEle.rotateZ(_rotation[2]);
    }

    if (_scale) {
      renderableEle.scale.set(..._scale);
    }

    // if (_scale) renderableEle.scale.set(..._scale);
    return renderableEle ;
  }

  // Function to make renderable and add to world using json data
  function printCardsItemFromJson(data) {
    // let cardObjects = JSON.parse(JSON.stringify(data));
    data.forEach(function(item, index) {
      let position  = [item.position._x, item.position._y, (index * -50) -50];
      let rotation  = [item.rotation._x, item.rotation._y, item.rotation._z];
      let scale = [item.scale._x, item.scale._y, item.scale._z];
      let renderableItem = createDOMRenderable(item.content, position, rotation, scale);
      world.add(renderableItem);

    });
  }

  // Initialize app.
  function initWorldObject3D(entity) {
    entity[0].addRenderable(world);
    currentTarget = LetseeEngine.getEntities()[0]
  }

  // Function to create card data.
  function createCard() {
    // document.querySelector("img[data-id='bfcc46bb-b047-4fcf-a8b5-9128139f1aff']")
    // 이미지 업로드시
    if(imageObj.files.length > 0) {

      const randomId = UUID();
      const type = "image";
      const content =
        `<div class="cardElement" data-type="card" data-id="${randomId}">
						<div class="wrapper">
							<div class="inner">
								<div class="imagebox">
								  <img src="" data-type="cardImage" data-id="${randomId}">
								</div>
							</div>
						</div>
					</div>`
      currentCardObject = updateCardObject({
        "id": randomId,
        "type": type,
        "content": content,
      });

      addCard();

    } else {
      window.alert('Please select photo file.');
    }
  }

  let renderable = null;
  let helpRenderable = null;
  let currentCardIndex = 0;

  // Function to make card renderable using card data and add gesture to move card.
  function addCard(imgData) {
    let position = [0,0,50 * currentCardIndex];
    let rotation = [0,0,0];
    let scale = [1,1,1];
    renderable = createDOMRenderable(currentCardObject.content, position, rotation, scale);
    world.add(renderable);


    position = [0,-25,50 * currentCardIndex];
    helpRenderable = createDOMRenderable(`<div id = "helpElement"></div>`, position, rotation, scale);
    world.add(helpRenderable);

    editObject = renderable;
    helpObject = helpRenderable;

    currentCardIndex ++;


    /**
     * src = 이미지 base64가 두번 호출되어야만 resizing 수행. => 원인 파악 x
     */
    ResizeImage();
    ResizeImage();

    goToMoveCardDiv();
  }

  // Function to remove card from layout
  function removeCard() {
    if(renderable !== null) {
      world.remove(renderable);
      editObject = null;
      currentCardIndex --;
      renderable = null;
    }
    //showInputConfirmDiv();
  }

  function removeHelper() {
    world.remove(helpRenderable);
    helpObject = null;
    helpRenderable = null;
  }

  // Function to post card data to server
  function postCard() {

    currentCardObject = updateCardObject(
      {
        "position": {
          "_x": editObject.position._x,
          "_y": editObject.position._y,
          "_z": editObject.position._z
        },
        "rotation": {
          "_x": editObject.rotation._x,
          "_y": editObject.rotation._y,
          "_z": editObject.rotation._z
        },
        "scale": {
          "_x": editObject.scale._x,
          "_y": editObject.scale._y,
          "_z": editObject.scale._z
        }
      }
    );

    if(currentCardObject.type === "image") {
      saveImage()
        .then((data) => {
          return saveResizedImage(data);
        })
        .then((data) => {
          return uploadImagesAndCardObject(data)
        })
        .then((result) => {
          console.log(result);
          goToMain(true);
        })
        .catch(error => {
          console.log(error);
        })
    }
  }

  let halfResizedFile = null;
  let resizedFile = null;

  // width, height 최대값이 380으로 이미지 리사이징.
  function ResizeImage() {
    if (window.File && window.FileReader && window.FileList && window.Blob) {
      const filesToUploads = imageObj.files;
      const file = filesToUploads[0];

      if (file) {
        const reader = new FileReader();
        // Set the image once loaded into file reader
        reader.onload = function(e) {
          let img = document.createElement("img");
          img.src = e.target.result;

          resizedFile = makeResizedImage(380, 380, img, file.type);
          halfResizedFile =  makeResizedImage(img.width / 2, img.height / 2, img, file.type);
        };
        reader.readAsDataURL(file);
      }
    } else {
      alert('The File APIs are not fully supported in this browser.');
    }
  }

  // Function to resize image to input size.
  function makeResizedImage(max_width, max_height, img , type, output) {
    let MAX_WIDTH = max_width;
    let MAX_HEIGHT = max_height;
    let width = img.width;
    let height = img.height;

    let canvas = document.createElement("canvas");
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);

    if (width > height) {
      if (width > MAX_WIDTH) {
        height *= MAX_WIDTH / width;
        width = MAX_WIDTH;
      }
    } else {
      if (height > MAX_HEIGHT) {
        width *= MAX_HEIGHT / height;
        height = MAX_HEIGHT;
      }
    }

    canvas.width = width;
    canvas.height = height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);

    let dataurl = canvas.toDataURL(type);
    let blob = dataURLToBlob(dataurl);
    let fileFromBlob = blobToFile(blob);

    let myImg = document.querySelector(`img[data-id='${currentCardObject.id}']`);
    myImg.src = dataurl;

    return fileFromBlob;
  }

  // Function to make dataurl image to blob type.
  let dataURLToBlob = function(dataURL) {
    let BASE64_MARKER = ';base64,';
    if (dataURL.indexOf(BASE64_MARKER) == -1) {
      let parts = dataURL.split(',');
      let contentType = parts[0].split(':')[1];
      let raw = parts[1];

      return new Blob([raw], {type: contentType});
    }

    let parts = dataURL.split(BASE64_MARKER);
    let contentType = parts[0].split(':')[1];
    let raw = window.atob(parts[1]);
    let rawLength = raw.length;

    let uInt8Array = new Uint8Array(rawLength);

    for (let i = 0; i < rawLength; ++i) {
      uInt8Array[i] = raw.charCodeAt(i);
    }

    return new Blob([uInt8Array], {type: contentType});
  };

  // Function to change blob data type to file type
  let blobToFile = function(blob) {
    const fd = new FormData();
    fd.set('a', blob);
    return fd.get('a');
  }

  let orientation;
  let base64data;
  let rectangleImg = document.getElementById("rectangleImg");

  document.getElementById('uploadImageInput').onchange = function(e) {
    loadImage(
      imageObj.files[0],
      function (img, data) {
        if(data.exif !== undefined) {

          getSizeOrientatedImageBinary(data, base64data);
          $("#upload_file_message").fadeOut();
          $("#picture_image").fadeOut();
        } else {
          rectangleImg.src = base64data;
        }
      },
      {meta : true}
    );

    let fileReader = new FileReader();
    fileReader.onload = function (e) {
      base64data = fileReader.result;
    };
    fileReader.readAsDataURL(imageObj.files[0]);
  };

  function getSizeOrientatedImageBinary (data, base64data) {
    let dummyImage = document.createElement('img');
    dummyImage.src = base64data;
    dummyImage.onload = () => {
      let img = document.getElementById("rectangleImg");
      let width = dummyImage.width;
      let height = dummyImage.height;

      let canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      let ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);
      let orientation = data.exif.get('Orientation');

      switch (orientation) {
        case 2:
          // horizontal flip
          ctx.translate(width, 0);
          ctx.scale(-1, 1);
          break;
        case 3:
          // 180° rotate left
          ctx.translate(width, height);
          ctx.rotate(Math.PI);
          break
        case 4:
          // vertical flip
          ctx.translate(0, height);
          ctx.scale(1, -1);
          break;
        case 5:
          // vertical flip + 90 rotate right
          ctx.rotate(0.5 * Math.PI);
          ctx.scale(1, -1);
          break;
        case 6:
          // 90° rotate right
          ctx.rotate(0.5 * Math.PI);
          ctx.translate(0, -height);
          break;
        case 7:
          // horizontal flip + 90 rotate right
          ctx.rotate(0.5 * Math.PI);
          ctx.translate(width, -height);
          ctx.scale(-1, 1);
          break;
        case 8:
          // 90° rotate left
          ctx.rotate(-0.5 * Math.PI);
          ctx.translate(-width, 0);
          break;
      }

      ctx.drawImage(dummyImage, 0, 0, width, height);
      dummyImage.onload = null;
      let dataurl = canvas.toDataURL(imageObj.files[0].type);
      img.src = dataurl;
    }
  };

  function fileClick() {
    document.all.uploadImageInput.click();
  }

  // function to get uuid
  function UUID() {
    let d = new Date().getTime();

    if (typeof performance !== 'undefined' && typeof performance.now === 'function') {
      d += performance.now(); // use high-precision timer if available
    }
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
      let r = (d + Math.random() * 16) % 16 | 0;

      d = Math.floor(d / 16);
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
  }

</script>
<script type="text/javascript" src="js/hammer.js"></script>
<script src="js/load-image.all.min.js"></script>
</html>
